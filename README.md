# **shardingupload**
## 分片上传、秒传、断点续存
**传统一次性上传文件的劣势：**
1. 大文件一次性传输速度慢
2. 容易出现卡死的情况
3. 网络不好存在需要重新上传的风险
4. 每个相同的文件都需要重新上传消耗时间

### 分片上传
将文件分成多个小块，每个小块单独上传，可以提高上传速度，减少卡死的风险，上传完之后合并所有文件### 秒传

### 断点续传
上传过程中断开连接，可以继续从上次上传的位置开始上传，避免重新上传已经上传的部分

### 秒传
通过文件唯一值判断文件是否已经上传过，避免重复上传 


### 步骤
1. /splitSave 接口将大文件分成小块保存
2. /shardingUpload 接口 通过md5校验是否是有相同的文件上传过，如果上传过则引用上传过的文件路径，不需要重新上传，提升效率(秒传)
3. 如果没有上传过则需要上传，这里重新再查询了一次是否上传过，上传过则提前查询文件路径，避免重复上传，没上传的话查看分片文件上传状态
4. 检查分片状态，查看是否是否上传过
5. 没有上传过则上传，上传过则断点续传，断点续传则查看是否全部上传完成，如果完成返回可合并，再查看是否上传过该分片，上传过就跳过，否则上传
6. uploadProgress 接口查询上传进度
7. mergeFile 单独的合并接口 - 前端在确认所有分片上传完成后调用，合并之后校验md5是否相同



**小坑**

测试是一台机器操作，线上如果是多台服务器的话，可能涉及到保存的分片不在同一台机器上的问题

如果前端使用一个接口上传分片的话，后端多线程操作，只是使用MultipartFile 上传文件的话，tomcat会临时保存文件，spring会把这些临时文件包装成MultipartFile对象使用，当主线程结束时会去删除这些临时文件，有可能别的文件还在执行就会找不到文件，就会说出现FileNotFoundException错误
,如果是前端发送的五次http请求就不会出现问题，因为每个请求的临时文件生命周期独立